(function(window, undefined)
{
	"use strict";
	
	if(window.frameElement)
		var parent = window.frameElement.ownerDocument.defaultView || window.frameElement.ownerDocument.parentWindow;
	else
		var parent = window;
	
	window.alertDiskOnly = parent.alertDiskOnly = function()
	{
		alert('Данная возможность доступна в дисковой версии');
	};
	
	window.alertBrokenLink = parent.alertBrokenLink = function()
	{
		alert('Ошибка! Неизвестная ссылка');
	};
	
	if(!window.frameElement)
	{
		var hash = window.location.hash;
		
		if(hash !== '_print' && hash !== '#_print')
		{
			var thisLoc = window.location.pathname.split('/');
			if(thisLoc[0] === '')
				thisLoc.shift();
			var appPath = thisLoc.shift();
			var mode = thisLoc.shift();
			var dbNick = thisLoc.shift();
			var docPath = thisLoc.join('/').replace(/\?[0-9]{10}=?/, '').replace(/_+$/, '');
			
			if(hash && hash.charAt(0) === '#')
				hash = hash.substr(1);
			
			var matchReferrer = new RegExp('^https?://' + location.hostname.replace(/\./g, '\\.') + '/' + appPath + '/' + dbNick + '(?:/|$)', 'i');
			
			var colon = encodeURIComponent(':');
			var matchUser = new RegExp('\\bUSER_TYPE=[' + colon + '\\d]*' + colon + '1' + colon);
			
			if(mode !== 'files'
			&& (document.referrer && !document.referrer.match(matchReferrer) || !document.referrer && document.cookie.match(matchUser)))
				window.location.replace('/' + appPath + '/' + dbNick + '#' + mode + ':' + docPath + '_' + (hash ? '?anchor=' + hash : ''));
		}
		else if(!document.getElementById('w_user_login_iframe'))
		{
			/*@cc_on
			if(true)
			{
				window.print();
			}
			else
			{
			@*/
				window.onload = function()
				{
					var imgs = document.getElementsByTagName('IMG');
					var incomplete = 0;
					
					var imgOnLoad = function()
					{
						incomplete--;
						
						if(incomplete === 0)
							window.print();
					};
					
					for(var i = 0; i < imgs.length; i++)
						if(imgs[i].complete === false)
						{
							imgs[i].onload = imgOnLoad;
							imgs[i].setAttribute('loading', 'eager');
							incomplete++;
						}
					
					if(!incomplete)
						window.print();
				};
			/*@cc_on
			}
			@*/
		}
	}
	else
	{
		if(parent.document.title === 'Document Moved')
			parent.location.reload(true);
		else
		{
			var SSP = parent.SSP;
			
			if(SSP && parent.App)
			{
				if(document.getElementById('w_user_login_iframe'))
				{
					var loginWidget = SSP.Widget('w_user_login');
					var loginWrapper = loginWidget.node.parentNode;
					
					if(SSP.DOM.hasClass(loginWrapper, 'authorized'))
						parent.App.User.refresh();
				}
				
				if(location.hostname.match(/\.eu$/))
				{
					var loginLink = document.getElementById('login_link_iframe');
					
					if(loginLink)
					{
						var parentLoc = parent.location.pathname.split('/');
						if(parentLoc[0] === '')
							parentLoc.shift();
						var appPath = '/' + parentLoc.shift() + '/';
						
						if(appPath !== '/db/')
						{
							appPath += parentLoc.shift() + '/';
							var pathEncoded = appPath.replace(/\//g, '%2F');
							var rx = new RegExp('\\?backurl=' + pathEncoded);
							
							if(!loginLink.href.match(rx))
								loginLink.href = loginLink.href.replace(/\?backurl=%2Fdb%2F/, '?backurl=' + pathEncoded);
						}
					}
				}
				
				setTimeout(SSP.Bus.runDeferred, 0);
				
				var checker = (function()
				{
					if(document.readyState === 'loaded'
					|| document.readyState === 'complete')
					{
						clearInterval(interval);
						SSP.Bus.runDeferred();
					}
				});
				var interval = setInterval(checker, SSP.DOM.timeoutTiny);
			}
		}
	}
}
)(window);