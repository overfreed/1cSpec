<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<!-- saved from url=(0051)http://v2.ax-online.ru/Exams/AttPlatf/Task-1.7.aspx -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta http-equiv="Page-Enter" content="progid:DXImageTransform.Microsoft.Fade(duration=0.2,overlap=1.0)">
    <link href="./решение 1.1_files/ax.css" rel="stylesheet" type="text/css">
    <link href="./решение 1.1_files/layout.css" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" href="http://v2.ax-online.ru/favicon.ico" type="image/vnd.microsoft.icon">
    
    <link href="./решение 1.1_files/AttPlatf.css" rel="stylesheet" type="text/css">

    <link rel="stylesheet" type="text/css" href="./решение 1.1_files/highslide.css">
    
    <title>Архитектура Х - 1С:Специалист по платформе 1С:Предприятие 8.2 - Задача 1.7 (оперативный учет)</title>


<style type="text/css">.highslide img {cursor: url(/highslide/graphics/zoomin.cur), pointer !important;}</style><script type="text/javascript" src="chrome-extension://aggiiclaiamajehmlfpkjmlbadmkledi/popup.js" async=""></script><script type="text/javascript" src="chrome-extension://aggiiclaiamajehmlfpkjmlbadmkledi/tat_popup.js" async=""></script></head>
<body id="i-Exams-AttPlatf-Task-1-7" class="spring">
	<div class="body_l">
		<div class="body_r">
		    <div class="body_c">
	            <div class="extra">
		            <div id="header">
			            <div class="inner">
				            <div class="main">
					            <div class="container">
						            <a id="logo" href="http://v2.ax-online.ru/Default.aspx"><img src="./решение 1.1_files/logo.gif" alt="Архитектура Х ∙ 1С:Франчайзи в Бийске"></a>
                                    <div id="today">
                                        <span title="Количество дней до Нового года: 304">3 марта 2020 г., вторник</span>
                                    </div>
                                    <div class="sub-menu">
                                        <ul><li><a href="http://v2.ax-online.ru/Login.aspx">Вход</a></li></ul>
                                        <ul>
                                            <li><a href="http://v2.ax-online.ru/Exams/Default.aspx">Сертификация</a></li>
                                            <li><a href="http://v2.ax-online.ru/Vacancies.aspx">Вакансии</a></li>
                                        </ul>
                                        <ul>
                                            <li><a href="http://v2.ax-online.ru/SiteMap.aspx">Карта сайта</a></li>
                                            <li><a href="http://twitter.com/ax_1csoft" rel="nofollow" target="_blank">Twitter</a></li>
                                        </ul>
						            </div>
					            </div>
					            <div class="menu">
						            <div class="menu-left">
							            <div class="menu-right">
								            <div class="container">
									            <ul>
										            <li class="first"><a href="http://v2.ax-online.ru/Default.aspx" class=""><span><strong>Главная</strong></span></a></li>
										            <li><a href="http://v2.ax-online.ru/AboutUs.aspx" class=""><strong>О компании</strong></a></li>
										            <li><a href="http://v2.ax-online.ru/1C/" class=""><strong>Услуги 1C</strong></a></li>
										            <li><a href="http://v2.ax-online.ru/Teaching.aspx" class=""><strong>Центр обучения</strong></a></li>
										            <li><a href="http://v2.ax-online.ru/Contacts.aspx" class=""><strong>Контакты</strong></a></li>
									            </ul>
									            <form id="SearchForm" action="http://v2.ax-online.ru/Exams/AttPlatf/Task-1.7.aspx" method="get" target="_blank">
										            <div>
                                                        <input type="hidden" name="enc" value="utf-8">
											            <label><input class="input" type="text" name="q" maxlength="256" size="20" value="Поиск по сайту ..." default="Поиск по сайту ..." onblur="InputOnblur(this)" onfocus="InputOnfocus(this)"></label>
											            <input type="image" id="search" src="./решение 1.1_files/input-img.gif" alt="Поиск">
										            </div>
									            </form>
								            </div>
							            </div>
						            </div>
					            </div>
				            </div>
			            </div>
		            </div>
		            <div id="content">
                        <form name="aspnetForm" method="post" action="http://v2.ax-online.ru/Exams/AttPlatf/Task-1.7.aspx" id="aspnetForm">
<div>
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwUKMjEwNDQyMTMxM2RkCVjGi5ODx1y+cC3lKndQiyWj4qvXDcDWM56L5yD2n1k=">
</div>

<div>

	<input type="hidden" name="__VIEWSTATEGENERATOR" id="__VIEWSTATEGENERATOR" value="FABF72B0">
</div>
		                
    <div class="main">
        <div class="indent padding">
            <div class="container">
                <div class="col-pad pad-left book">
                    

    <div class="padding">
        <h2>
            <a id="ref-2-site" href="http://v2.ax-online.ru/Exams/AttPlatf/Task-1.7.aspx#" title="При полном или частичном использовании материалов этой страницы ссылка на наш сайт приветствуется!">
            </a>
            Оперативный учет - Задача 1.7
        </h2>
        <div class="justify">
            В условии задачи впервые встречается складской учет: учёт товаров ведётся в разрезе
            складов, которые нужно указывать в шапке документа. Кроме того, при проведении документа
            «Расходная накладная» требуется формировать только часть движений, а именно - производить
            списание товара со склада в количественном выражении. Все остальные движения, требующие
            расчёта себестоимости списанных товаров, необходимо делать позднее или по расписанию
            (с помощью регламентного задания), или по желанию пользователя (с помощью обработки).
        </div>
        <p class="justify">
            Далее, и обработка, и регламентное задание должны автоматически определять самую
            первую «Расходную накладную», нуждающуюся в расчёте себестоимости. Процесс расчёта
            должен начинаться с нее, а затем выполняться в хронологическом порядке для всех
            последующих документов «Расходная накладная». При этом, не смотря на наличие складского
            учета, при расчёте себестоимости требуется учитывать только момент поступления товара
            в компанию, вне зависимости от того, на какой склад он пришёл.
        </p>
        <p class="justify">
            Необходимо построить отчет по продажам товаров за период и остаткам товара на указанную
            дату. Формы отчетов отличаются от тех, что были рассмотрены нами ранее, но это различие
            не является существенным. Поэтому, данные отчеты будут оставлены нами без внимания.
        </p>
    </div>

    <div class="padding">
        <h2 class="pad">Обсуждение …</h2>
        <p class="justify">
            Cтоит обсудить всего три вопроса:
        </p>
        <ul class="pad-left pad2">
            <li class="yellow">Какие регистры нам потребуется для ведения складского и партионного учёта.</li>
            <li class="yellow">Какую технологию применить для реализации отложенного <span class="black">расчёта себестоимости</span>.</li>
            <li class="yellow">Каким образом наша программа (обработка) будет определять <span class="black">самый первый документ</span>.</li>
        </ul>
        <p class="justify">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 1">
            Пытаясь разобраться с количеством регистров, обратимся к пояснениям в тексте задаче. Их
            можно перефразировать так: "При списании себестоимости выбор партии производится
            вне зависимости от того, на какой склад партия была прията". Из этого можно сделать
            вывод о том, что складской и партионный учёт должны быть независимыми. Следовательно,
            логичнее всего для каждого из них создать свой собственный независимый регистр.
        </p>
        <p class="justify">
            Естественно, оба регистра должны быть регистрами накопления остатков, поскольку
            в складском учёте нам потребуется учитывать приход и расход товаров на склад, а
            в партионном учете - приход и расход партий. Для складского учёта можно будет использовать
            уже имеющийся регистр <span class="b">ОстаткиНоменклатуры</span> (только нужно будет
            добавить в него измерение <span class="b">Склад</span>). Для партионного учёта создадим
            новый регистр <span class="b">СтоимостьНоменклатуры</span> с измерениями
            <span class="b">Номенклатура</span>, <span class="b">Партия</span> и ресурсами <span class="b">Количество</span>, <span class="b">Стоимость</span>.
        </p>
        <p class="justify">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 2">
            Движения в регистр <span class="b">ОстаткиНоменклатуры</span> документ <span class="b">
                РасходнаяНакладная</span> будет писать самостоятельно (в момент проведения).
            А движения в регистры <span class="b">СтоимостьНоменклатуры</span> и <span class="b">
                Продажи</span> (в нём тоже фигурирует себестоимость) вроде как должны писать
            обработка и регламентное задание, потому что именно они выполняют <span class="black">
                расчёт себестоимости</span>. Но тут нужно вспомнить, что регистрам накопления
            в обязательном порядке требуется регистратор. А регистратором может быть только
            документ. Следовательно, движения связанные с расчётом себестоимости
            <span class="b">РасходнаяНакладная</span> тоже должна выполнять самостоятельно. Обработка
            и регламентное задание должны лишь побудить её к этому.
        </p>
        <p class="justify">
            Возникает вопрос: "Как побудить?". Первое, что приходит в голову, это - создать экспортный
            метод документа <span class="b">РасходнаяНакладная</span> и вызывать его из обработки
            и регламентного задания. Но это вариант отвергнем как не очень красивый. Вместо
            него предложим другой технологию: обработка и регламентное задание будут просто
            инициировать проведение документа <span class="b">РасходнаяНакладная</span>. А чтобы
            метод <span class="b">ОбработкаПроведения</span> документа мог понять при каких обстоятельствах
            он вызывается, ему будет передаваться <span class="black">"особый знак"</span>.
        </p>
        <p class="justify">
            Действительно, любой документ имеет свойство <span class="b">ДополнительныеСвойства</span>.
            Ничто не мешает нам на время выполнения обработки и регламентного задания определять
            в нём какое-либо свойство (скажем <span class="b">Состояние</span> со значением
            <span class="r">Допроведение</span>). Наличие такого свойства и будет нашим особым
            знаком! Таким образом, будем считать, что когда документ не имеет упомянутого свойства,
            то при его проведении требуется создавать только часть движений, относящаяся к количественному
            учету. Иначе - только часть движений, относящаяся к расчету себестоимости.
        </p>
        <p class="justify">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 3">
            Осталось обсудить последний момент: каким же образом обработка будет определять
            <span class="black">самый первый документ</span> для расчета себестоимости? Предлагаем для этого 
            завести константу для храния даты самого раннего документа, требующего допроведения.
            Следить за значением этой константы несложно. Каждый раз, когда документ формирует
            первую часть движений, он будет сравнивает свою дату с датой, сохранённой константе, и,
            если его дата более ранняя (или если константа вообще не содержит даты), сохранит
            в константе свою дату.
        </p>
        <p class="justify">
            Конечно, лучше было бы хранить не дату, а <span class="b">МоментВремени</span>,
            содержащий помимо прочего ещё и ссылку на конкретный документ. Но, к сожалению константы
            не могут иметь токой тип. Поэтому, согласимся на эдакое небольшое отступление
            от условия задачи: будем определять не самый первый документ, а самую раннюю дату.
            И если на эту дату имеется несколько документов, то все их и допроведём. Памятуя
            о том, что дата документа это не только дата, но ещё и время с точностью до секунды,
            можно предположить, что лишь в особых случаях нам потребуется допроводить много
            лишних документов.
        </p>
        <p class="justify">
            В прочем, если Вы твёрдо настроены, исполнить задачу в строгом соответствии с её
            требованиями, то Вам не составит особого труда переработать этот маленький кусочек,
            в то время как всё остальное уже исправно работает. Резюмируя всё вышесказанное,
            составим план действий:
        </p>
        <ul class="pad-left pad2">
            <li class="green">Создаем справочник <span class="b">Склады</span>;</li>
            <li class="green">В документы <span class="b">ПриходнаяНакладная</span> и <span class="b">РасходнаяНакладная</span>, добавляем реквизит <span class="b">Склад</span>;</li>
            <li class="green">В регистр <span class="b">ОстаткиНоменклатуры</span>, добавляем измерение <span class="b">Склад</span>;</li>
            <li class="green">Создаем регистр <span class="b">СтоимостьНоменклатуры</span>, с измерениями <span class="b">Партия</span>, <span class="b">Номенклатура</span> и ресурсами <span class="b">Количество</span>, <span class="b">Стоимость</span>;</li>
            <li class="green">Создаем <span class="black">константу для хранения даты самого раннего документа, требующего допроведения</span>.</li>
            <li class="green">В документе <span class="b">ПриходнаяНакладная</span> предусматриваем запись движений сразу в оба регистра;</li>
            <li class="green">В документе <span class="b">РасходнаяНакладная</span> предусматриваем проверку наличия <span class="black">дополнительного свойства</span>, и выбор варианта проведения документа
                <ul class="pad-left pad2">
                    <li class="green">Если <span class="black">дополнительного свойства</span> нет, то
                        <ul class="pad-left pad2">
                            <li class="green">делаем движения в регистре <span class="b">ОстаткиНоменклатуры</span>,</li>
                            <li class="green">стираем движения в регистрах <span class="b">СтоимостьНоменклатуры</span> и <span class="b">Продажи</span>,</li>
                            <li class="green">Если нужно, сдвигаем константу на более раннюю дату документа.</li>
                        </ul>
                    </li>
                    <li class="green">Если <span class="black">дополнительное свойство</span> есть, то
                        <ul class="pad-left pad2">
                            <li class="green">Делаем движения в регистрах <span class="b">СтоимостьНоменклатуры</span> и <span class="b">Продажи</span>.</li>
                        </ul>
                    </li>
                </ul>
            </li>
            <li class="green">Создаем обработку и регламентное задание выполняющие одни и те же действия:
                <ul class="pad-left pad2">
                    <li class="green">Выбрать все проведённые документы <span class="b">РасходнаяНакладная</span>, начиная с даты указанной в <span class="black">константе</span>;</li>
                    <li class="green">Последовательно, в порядке возрастания <span class="b">МоментаВремени</span> документов, вызвать их метод <span class="b">Записать</span>, так чтобы он инициировал процедуру проведения, но перед каждым таким вызовом
                        <ul class="pad-left pad2">
                            <li class="green">не забываем устанавливать <span class="black">дополнительное свойство</span> документа, чтобы он знал, что находится в фазе допроведения,</li>
                            <li class="green">и, сдвигать дату <span class="black">константы</span> на <span class="b">МоментаВремени</span> очередного документа, чтобы в случае сбоя при проведении документа, не начинать всё с самого начала;</li>
                        </ul>
                    </li>
                    <li class="green">Когда все документы обработаны, очистить <span class="black">константу</span>, в знак того, что <span class="black">расчёт себестоимости</span> завершён успешно.</li>
                </ul>
            </li>
        </ul>
    </div>

    <div class="padding">
        <h2 class="pad">Решение …</h2>
        
        <p class="justify">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 1">
            Создаем справочник <span class="b">Склады</span> и включаем его в подсистему,
            <span class="b">ОперативныйУчет</span>/<span class="b">Справочники</span>.
            <br>
            <br>
        </p>
        <div class="pad2 aligncenter">
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_01.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_01-s.png" alt="Создаем справочник «Склады»">
            </a>
            <div class="highslide-caption">Создаем справочник «Склады»</div>                        
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_02.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_02-s.png" alt="Добавляем его в подсистему «ОперативныйУчет»/«Справочники»">
            </a>
            <div class="highslide-caption">Добавляем его в подсистему «ОперативныйУчет»/«Справочники»</div>                        
        </div>
        <p class="justify pad1">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 2">
            В документы <span class="b">ПриходнаяНакладная</span> и <span class="b">РасходнаяНакладная</span>,
            добавляем реквизит, а в регистр <span class="b">ОстаткиНоменклатуры</span> - измерение,
            <span class="b">Склад</span> типа <span class="r">Справочники.Склады</span>;
            <br>
        </p>
        <div class="pad2 aligncenter">
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_03.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_03-s.png" alt="В документ «ПриходнаяНакладная» добавиляем реквизит «Склад»">
            </a>
            <div class="highslide-caption">В документ «ПриходнаяНакладная» добавиляем реквизит «Склад»</div>                        
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_04.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_04-s.png" alt="В документ «РасходнаяНакладная» добавиляем реквизит «Склад»">
            </a>
            <div class="highslide-caption">В документ «РасходнаяНакладная» добавиляем реквизит «Склад»</div>                        
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_05.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_05-s.png" alt="В регистр «ОстаткиНоменклатуры» добавиляем измерение «Склад»">
            </a>
            <div class="highslide-caption">В регистр «ОстаткиНоменклатуры» добавиляем измерение «Склад»</div>                        
        </div>
        <p class="justify pad1">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 3">
            Создаем регистр накопления <span class="b">СтоимостьНоменклатуры</span> типа
            <span class="r">Остатки</span>, добавляем его в подсистему <span class="b">ОперативныйУчет</span>.
            На закладке «Данные» создаём измерения <span class="b">Партия</span> типа
            <span class="r">Документы.ПриходнаяНакладная</span> и <span class="b">Номенклатура</span>
            типа <span class="r">Справочники.Номенклатура</span>, а так же ресурсы
            <span class="b">Количество</span> и <span class="b">Стоимость</span> на закладке «Движения»
            укажем, что регистраторами являются документы <span class="b">ПриходнаяНакладная</span> и
            <span class="b">Расходная Накладная</span>.
        </p>
        <div class="pad2 aligncenter">
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_06.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_06-s.png" alt="Создаем регистр накопления «СтоимостьНоменклатуры» типа «Остатки»">
            </a>
            <div class="highslide-caption">Создаем регистр накопления «СтоимостьНоменклатуры» типа «Остатки»</div>                        
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_07.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_07-s.png" alt="Добавляем его в подсистему «ОперативныйУчет»">
            </a>
            <div class="highslide-caption">Добавляем его в подсистему «ОперативныйУчет»</div>                        
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_08.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_08-s.png" alt="Создаём измерения «Партия» и «Номенклатура», ресурсы «Количество» и «Стоимость»">
            </a>
            <div class="highslide-caption">Создаём измерения «Партия» и «Номенклатура», ресурсы «Количество» и «Стоимость»</div>                        
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_09.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_09-s.png" alt="Регистраторы «ПриходнаяНакладная» и «РасходнаяНакладная»">
            </a>
            <div class="highslide-caption">Регистраторы «ПриходнаяНакладная» и «РасходнаяНакладная»</div>                        
        </div>
        <p class="justify pad1">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 4">
            Создаем константу <span class="b">НачалоРасчетаСебестоимости</span> типа
            <span class="r">Дата</span>, <span class="b">Состав даты</span>
            <span class="r">Дата и время</span>, убираем галочку со свойства
            <span class="b">Использовать стандартные команды</span>, чтобы оградить её от пользователей.
            На первой закладке панели «Дополнительно» отмечаем, что она входит в подсистему
            <span class="b">Оперативный Учет</span>.
        </p>
        <p class="justify">
            Создаём общий модуль <span class="b">РаботаНаСервере</span>, ставим галочки
            <span class="b">Сервер</span>, <span class="b">Вызов сервера</span>, на первой закладке
            панели «Дополнительно» отмечаем, что он входит в подсистему <span class="b">ОперативныйУчет</span>.
        </p>
        <div class="pad2 aligncenter">
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_10.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_10-s.png" alt="Создаем константу «НачалоРасчетаСебестоимости» типа «Дата», состав «Дата и время»">
            </a>
            <div class="highslide-caption">Создаем константу «НачалоРасчетаСебестоимости» типа «Дата», состав «Дата и время»</div>                        
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_11.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_11-s.png" alt="Создаём общий модуль «РаботаНаСервере», отмечаем типа «Сервер» и «Вызов сервера»">
            </a>
            <div class="highslide-caption">Создаём общий модуль «РаботаНаСервере», отмечаем типа «Сервер» и «Вызов сервера»</div>                        
       </div>
        <p class="justify pad1">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 5">
            В общем модуле <span class="b">РаботаНаСервере</span> описываем экспортную процедуру
            <span class="b">РассчитатьСебестоимость</span>, к которой будут обращаться обработка
            и регламентное задание.
        </p>
<pre class="pad1"><span class="b"><span class="r">Процедура</span> РассчитатьСебестоимость<span class="r">() Экспорт</span>

    <span class="g">// Получаем значение константы</span>
    НачалоРасчета <span class="r">=</span> Константы<span class="r">.</span>НачалоРасчетаСебестоимости<span class="r">.</span>Получить<span class="r">();</span>

    <span class="g">// Если значением константы является пустая дата, значит, ничего делать не нужно - возвращаемся из процедуры </span>
    <span class="r">Если</span> НачалоРасчета <span class="r">=</span> <span class="black">'00010101'</span> <span class="r">Тогда

        Возврат;

    КонецЕсли;</span>

    <span class="g">// Выбираем ссылки все проведённые «Расходные накладные» начиная с указанной даты, и
    // упорядочиваем их по моменту времени</span>
    Запрос <span class="r">= Новый</span> Запрос<span class="r">;</span>
    Запрос.Текст <span class="r">=</span> 
        <span class="black">"ВЫБРАТЬ
        |	РасходнаяНакладная.Ссылка
        |ИЗ
        |	Документ.РасходнаяНакладная КАК РасходнаяНакладная
        |ГДЕ
        |	РасходнаяНакладная.Дата &gt;= &amp;Дата
        |	И РасходнаяНакладная.Проведен
        |
        |УПОРЯДОЧИТЬ ПО
        |	РасходнаяНакладная.МоментВремени"</span><span class="r">;</span>
    Запрос<span class="r">.</span>УстановитьПараметр<span class="r">(</span><span class="black">"Дата"</span><span class="r">,</span> НачалоРасчета<span class="r">);</span>
    ВыборкаДетальныеЗаписи <span class="r">=</span> Запрос<span class="r">.</span>Выполнить<span class="r">().</span>Выбрать<span class="r">();</span>

    <span class="g">// В цикле, для каждой ссылки...</span>
    <span class="r">Пока</span> ВыборкаДетальныеЗаписи<span class="r">.</span>Следующий<span class="r">() Цикл</span>
    
        <span class="g">// ... выбираем соответствующий ей документ,</span>
        РасходнаяНакладная <span class="r">=</span> ВыборкаДетальныеЗаписи<span class="r">.</span>Ссылка<span class="r">.</span>ПолучитьОбъект<span class="r">();</span>
        
        <span class="g">// переводим константу на момент времени документа,</span>
        Константы<span class="r">.</span>НачалоРасчетаСебестоимости<span class="r">.</span>Установить<span class="r">(</span>РасходнаяНакладная<span class="r">.</span>МоментВремени<span class="r">().</span>Дата<span class="r">);</span>
        
        <span class="g">// устанавливаем дополнительное свойство документа ("тайный знак"),</span>
        РасходнаяНакладная<span class="r">.</span>ДополнительныеСвойства<span class="r">.</span>Вставить<span class="r">(</span><span class="black">"Состояние"</span><span class="r">,</span> <span class="black">"Допроведение"</span><span class="r">);</span>
        
        <span class="g">// побуждаем документ, выполнить процедуру проведения.</span>
        РасходнаяНакладная<span class="r">.</span>Записать<span class="r">(</span>РежимЗаписиДокумента<span class="r">.</span>Проведение<span class="r">,</span> РежимПроведенияДокумента<span class="r">.</span>Неоперативный<span class="r">);
        
        <span class="g">// Если в процессе проведения возникнет исключение, то исполнение этой процедуры прекратится не доходя</span>
        <span class="g">// до конца цикла, но константа уже будет содержать дату документа, который не удалось провести.</span>
    КонецЦикла;</span>
    
    <span class="g">// Если цикл успешно завершился, значит, все документы проведены, и больше делать нечего, поэтому</span>
    <span class="g">// присваиваем константе пустую дату.</span>
    Константы<span class="r">.</span>НачалоРасчетаСебестоимости<span class="r">.</span>Установить<span class="r">(</span><span class="black">'00010101'</span><span class="r">);

КонецПроцедуры</span>
</span></pre>
        <p class="justify pad1">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 6">
            Теперь всё готово для создания регламентного задания и обработки. Чтобы не городить
            огород и не выдумывать витиеватых имён назовём их одинаково <span class="b">РасчетСебестоимости</span>
        </p>
        <p class="justify">
            Регламентному заданию укажем <span class="b">Имя метода</span> <span class="r">РаботаНаСервере.РассчитатьСебестоимость</span>,
            на первой закладке панели «Дополнительно» отмечаем, что оно входит в подсистему <span class="b">Оперативный Учет</span>.
        </p>
        <div class="pad2 aligncenter">
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_12.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_12-s.png" alt="Создаем регламентное задание «РасчетСебестоимости», имя метода «РаботаНаСервере.РассчитатьСебестоимость»">
            </a>
            <div class="highslide-caption">Создаем регламентное задание «РасчетСебестоимости», имя метода «РаботаНаСервере.РассчитатьСебестоимость»</div>                        
        </div>
        <p class="justify">
            Реламентное задание автоматически запускается и выполняется кластером серверов если
            база данных реализована в клиент-серверном варианте. Если же у Вас файловая база
            данных, то Вы даже не сможете его протестировать. Поэтому мы не будем углубляться
            в подробности.
        </p>
        <p class="justify">
            Упомянем только, что ещё нужно определить расписание, но в задаче не дано конкретных
            указаний о том, какое должно быть расписание. Так что Вам придётся ориентироваться
            на расписание приёма экзаменов. Когда будете сдавать задание (или когда его будут
            проверять), тогда регламентное задание и должно сработать [и то если на экзамене
            Вам дадут клиент-сервенную базу данных].
        </p>
        <p class="justify pad1">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 7">
            Переходим к созданию обработки. Исполним её в духе минимализма - ничего лишнего,
            чтобы поменьше запоминать.
        </p>
        <p class="justify">
            Итак, создаем обработку <span class="b">РасчетСебестоимости</span>, включаем её в подсистему
            <span class="b">ОперативныйУчет</span>, создаем для неё форму. В форме определяем команду
            <span class="b">РассчитатьСебестоимость</span>, и переносим её в командную панель формы.
            Теперь в панели «Свойства» команды тыкаем на лупу в поле ввода <span class="b">Действие</span>,
            конфигуратор автоматически создаст в модуле формы процедуру
            <span class="b">РассчитатьСебестоимость</span>, и назначит её действием команды.
        </p>
        <div class="pad2 aligncenter">
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_13.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_13-s.png" alt="Создаем обработку «РасчетСебестоимости»">
            </a>
            <div class="highslide-caption">Создаем обработку «РасчетСебестоимости</div>                        
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_14.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_14-s.png" alt="Включаем её в подсистему «ОперативныйУчет»">
            </a>
            <div class="highslide-caption">Включаем её в подсистему «ОперативныйУчет»</div>                        
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_15.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_15-s.png" alt="создаем для неё форму">
            </a>
            <div class="highslide-caption">создаем для неё форму</div>                        
            <a onclick="return hs.expand(this)" href="http://v2.ax-online.ru/Exams/AttPlatf/i/Task-1-7_16.png.ashx">
                <img src="./решение 1.1_files/Task-1-7_16-s.png" alt="В форме создаем команду «РасчитатьСебестоимость», переносим её в командную панель формы, и назначаем её действием одноименную процедуру модуля формы">
            </a>
            <div class="highslide-caption">В форме создаем команду «РасчитатьСебестоимость», переносим её в командную панель формы, и назначаем её действием одноименную процедуру модуля формы</div>                        
        </div>
        <p class="justify">
            В этой процедуре всего-то и нужно, что вызвать метод общего модуля.
        </p>
<pre class="pad1"><span class="b"><span class="p">&amp;НаКлиенте</span>
<span class="r">Процедура</span> РассчитатьСебестоимость<span class="r">(Команда)</span>

    РаботаНаСервере<span class="r">.</span>РассчитатьСебестоимость<span class="r">();

КонецПроцедуры</span>
</span></pre>
        <p class="justify pad1">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 8">
            Вот, теперь вся инфраструктура готова, осталось реализовать проведение документов.
            В документе <span class="b">ПриходнаяНакладная</span> всё как всегда, только регистров
            теперь два и склад появился.
        </p>
<pre class="pad1"><span class="b"><span class="r">Процедура</span> ОбработкаПроведения<span class="r">(</span>Отказ<span class="r">,</span> Режим<span class="r">)</span>

    Движения<span class="r">.</span>ОстаткиНоменклатуры<span class="r">.</span>Записывать <span class="r">= Истина;</span>
    Движения<span class="r">.</span>СтоимостьНоменклатуры<span class="r">.</span>Записывать <span class="r">= Истина;</span>

    Запрос <span class="r">= Новый</span> Запрос<span class="r">;</span>
    Запрос<span class="r">.</span>Текст <span class="r">=</span> 
        <span class="black">"ВЫБРАТЬ
        |	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура,
        |	СУММА(ПриходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество,
        |	СУММА(ПриходнаяНакладнаяСписокНоменклатуры.Сумма) КАК Сумма
        |ИЗ
        |	Документ.ПриходнаяНакладная.СписокНоменклатуры КАК ПриходнаяНакладнаяСписокНоменклатуры
        |ГДЕ
        |	ПриходнаяНакладнаяСписокНоменклатуры.Ссылка = &amp;Ссылка
        |	И ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура.ВидНоменклатуры = &amp;ВидНоменклатуры
        |
        |СГРУППИРОВАТЬ ПО
        |	ПриходнаяНакладнаяСписокНоменклатуры.Номенклатура"</span><span class="r">;</span>
    Запрос<span class="r">.</span>УстановитьПараметр<span class="r">(</span><span class="black">"ВидНоменклатуры"</span>, Перечисления<span class="r">.</span>ВидыНоменклатуры<span class="r">.</span>Товар<span class="r">);</span>
    Запрос<span class="r">.</span>УстановитьПараметр<span class="r">(</span><span class="black">"Ссылка"</span><span class="r">,</span> Ссылка<span class="r">);</span>
    ВыборкаДетальныеЗаписи <span class="r">=</span> Запрос<span class="r">.</span>Выполнить<span class="r">().</span>Выбрать<span class="r">();</span>

    <span class="r">Пока</span> ВыборкаДетальныеЗаписи<span class="r">.</span>Следующий<span class="r">() Цикл</span>

        <span class="g">// регистр ОстаткиНоменклатуры Приход</span>
        Движение <span class="r">=</span> Движения<span class="r">.</span>ОстаткиНоменклатуры<span class="r">.</span>Добавить<span class="r">();</span>
        Движение<span class="r">.</span>ВидДвижения <span class="r">=</span> ВидДвиженияНакопления<span class="r">.</span>Приход<span class="r">;</span>
        Движение<span class="r">.</span>Период <span class="r">=</span> Дата<span class="r">;</span>
        Движение<span class="r">.</span>Склад <span class="r">=</span> Склад<span class="r">;</span>
        Движение<span class="r">.</span>Номенклатура <span class="r">=</span> ВыборкаДетальныеЗаписи<span class="r">.</span>Номенклатура<span class="r">;</span>
        Движение<span class="r">.</span>Количество <span class="r">=</span> ВыборкаДетальныеЗаписи<span class="r">.</span>Количество<span class="r">;</span>

        <span class="g">// регистр СтоимостьНоменклатуры Приход</span>
        Движение <span class="r">=</span> Движения<span class="r">.</span>СтоимостьНоменклатуры<span class="r">.</span>Добавить<span class="r">();</span>
        Движение<span class="r">.</span>ВидДвижения <span class="r">=</span> ВидДвиженияНакопления<span class="r">.</span>Приход<span class="r">;</span>
        Движение<span class="r">.</span>Период <span class="r">=</span> Дата<span class="r">;</span>
        Движение<span class="r">.</span>Номенклатура <span class="r">=</span> ВыборкаДетальныеЗаписи<span class="r">.</span>Номенклатура<span class="r">;</span>
        Движение<span class="r">.</span>Партия <span class="r">=</span> Ссылка<span class="r">;</span>
        Движение<span class="r">.</span>Количество <span class="r">=</span> ВыборкаДетальныеЗаписи<span class="r">.</span>Количество<span class="r">;</span>
        Движение<span class="r">.</span>Стоимость <span class="r">=</span> ВыборкаДетальныеЗаписи<span class="r">.</span>Сумма<span class="r">;

    КонецЦикла;

КонецПроцедуры</span>
</span></pre>
        <p class="justify">
            Не знаю, тут, по-моему, даже и пояснять-то особо нечего - ничего нового. Давайте
            лучше перейдём к расходной накладной - там будет малость поинтересней.
        </p>
        <p class="justify pad1">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 9">
            Ну, вот значит <span class="b">ОбработкаПроведения</span> «расходной накладной».
            Для наглядности процедуры проведения вынесем в отдельные методы, чтобы алгоритм
            принятия решения можно было обозреть целиком.
        </p>
<pre class="pad1"><span class="b"><span class="r">Процедура </span>ОбработкаПроведения<span class="r">(</span>Отказ<span class="r">, </span>Режим<span class="r">)</span>

    <span class="g">// Проверяем, не подаёт ли нам кто-нибудь "тайный знак"</span>
    <span class="r">Если </span>ЭтотОбъект<span class="r">.</span>ДополнительныеСвойства<span class="r">.</span>Свойство<span class="r">(</span><span class="black">"Состояние"</span><span class="r">)
        И (</span>ЭтотОбъект<span class="r">.</span>ДополнительныеСвойства<span class="r">.</span>Состояние <span class="r">= </span><span class="black">"Допроведение"</span><span class="r">) Тогда

        <span class="g">// Если подает, то рассчитываем себестоимость</span>
        </span>РассчитатьСебестоимость<span class="r">(</span>Отказ<span class="r">);

    Иначе

        <span class="g">// Если не подает, то просто списываем количество</span>
        </span>СписатьКоличество<span class="r">(</span>Отказ<span class="r">);

        <span class="g">// Если никаких проблем со списанием не возникло, то ...</span>
        Если Не </span>Отказ <span class="r">Тогда

            <span class="g">// ... будем стирать [возможно] устаревшие данные о себестоимости,</span>
            </span>Движения<span class="r">.</span>СтоимостьНоменклатуры<span class="r">.</span>Записывать <span class="r">= Истина;
            </span>Движения<span class="r">.</span>Продажи<span class="r">.</span>Записывать <span class="r">= Истина;

            <span class="g">// получим значение константы и,</span>
            </span>НачалоРасчета <span class="r">= </span>Константы<span class="r">.</span>НачалоРасчетаСебестоимости<span class="r">.</span>Получить<span class="r">();

            <span class="g">// если это пустая</span>
            Если (</span>НачалоРасчета <span class="r">= </span><span class="black">'00010101'</span><span class="r">)</span>
                <span class="g">// или более поздняя дата</span>
                <span class="r">Или (</span>НачалоРасчета <span class="r">&gt; </span>МоментВремени<span class="r">().</span>Дата<span class="r">) Тогда

                <span class="g">// устанавливаем константу на момент времени документа.</span>
                </span>Константы<span class="r">.</span>НачалоРасчетаСебестоимости<span class="r">.</span>Установить<span class="r">(</span>МоментВремени<span class="r">().</span>Дата<span class="r">);

            КонецЕсли;

        КонецЕсли;

    КонецЕсли;

КонецПроцедуры</span>
</span></pre>
        <p class="justify">
            После того как мы вынести все особенности принятия решения, и сопутствующие ему
            мероприятия в отдельный алгоритм, процедуры проведения выглядят привычно и обыденно
            - глазу не за что зацепиться. И это хорошо, если код выглядит совершенно шаблонно,
            то его и понять и поддерживать проще, и ошибиться негде. Но для полноты картины
            мы его всё-таки опубликуем (с минимумом комментариев).
        </p>
        <p class="justify pad1">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 10">
            Первый этап проведения - формирование движений по регистру складского учёта
            <span class="b">ОстаткиНоменклатуры</span> - выполняет процедура с немудрящим
            названием <span class="b">СписатьКоличество</span>.
        </p>
<pre class="pad1"><span class="b"><span class="g">// Даём ей параметр Отказ, чтобы она могла сообщить, если что-то пойдёт не так.</span>
<span class="r">Процедура </span>СписатьКоличество<span class="r">(</span>Отказ<span class="r">)

    <span class="g">// А дальше всё своим чередом. Записываем только в регистр Остатки Номенклатуры, об остальных мы уже позаботились</span>
    </span>Движения<span class="r">.</span>ОстаткиНоменклатуры<span class="r">.</span>Записывать <span class="r">= Истина;

    
    <span class="g">// Готовимся блокировать прежние записи регистра</span>
    </span>Движения<span class="r">.</span>ОстаткиНоменклатуры<span class="r">.</span>БлокироватьДляИзменения <span class="r">= Истина;

    <span class="g">// Готовимся блокировать номенклатуру, упомянутую в табличной части</span>
    </span>Блокировка <span class="r">= Новый </span>БлокировкаДанных<span class="r">;
    </span>ЭлементБлокировки <span class="r">= </span>Блокировка<span class="r">.</span>Добавить<span class="r">(</span><span class="black">"РегистрНакопления.ОстаткиНоменклатуры"</span><span class="r">);
    </span>ЭлементБлокировки<span class="r">.</span>Режим <span class="r">= </span>РежимБлокировкиДанных<span class="r">.</span>Исключительный<span class="r">;
    </span>ЭлементБлокировки<span class="r">.</span>ИсточникДанных <span class="r">= </span>СписокНоменклатуры<span class="r">;
    </span>ЭлементБлокировки<span class="r">.</span>ИспользоватьИзИсточникаДанных<span class="r">(</span><span class="black">"Номенклатура"</span><span class="r">, </span><span class="black">"Номенклатура"</span><span class="r">);

    
    <span class="g">// Подготавливаем запрос:
    //   1) Берём из табличной части только номенклатуру и количество, сворачивая "дубли строк" и отсеивая всё кроме
            товаров, и кладём во временную таблицу
    //   2) присоединяем остатки на указанном складе, на указанный момент времени</span>
    </span>Запрос <span class="r">= Новый </span>Запрос<span class="r">;
    </span>Запрос<span class="r">.</span>Текст <span class="r">=
        </span><span class="black">"ВЫБРАТЬ
        |   РасходнаяНакладнаяСписокНоменклатуры.Номенклатура,
        |   СУММА(РасходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество
        |ПОМЕСТИТЬ РасходнаяНакладная
        |ИЗ
        |   Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
        |ГДЕ
        |   РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &amp;Ссылка
        |   И РасходнаяНакладнаяСписокНоменклатуры.Номенклатура.ВидНоменклатуры = &amp;ВидНоменклатуры
        |
        |СГРУППИРОВАТЬ ПО
        |   РасходнаяНакладнаяСписокНоменклатуры.Номенклатура
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ
        |   РасходнаяНакладная.Номенклатура КАК Номенклатура,
        |   РасходнаяНакладная.Количество КАК Количество,
        |   ЕСТЬNULL(ОстаткиНоменклатурыОстатки.КоличествоОстаток, 0) КАК КоличествоОстаток
        |ИЗ
        |   РасходнаяНакладная КАК РасходнаяНакладная
        |       ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.ОстаткиНоменклатуры.Остатки(
        |               &amp;МоментВремени,
        |               Склад = &amp;Склад
        |                   И Номенклатура В
        |                       (ВЫБРАТЬ
        |                           РасходнаяНакладная.Номенклатура
        |                       ИЗ
        |                           РасходнаяНакладная)) КАК ОстаткиНоменклатурыОстатки
        |       ПО РасходнаяНакладная.Номенклатура = ОстаткиНоменклатурыОстатки.Номенклатура"</span><span class="r">;

    <span class="g">// Задаём параметры запроса,</span>
    </span>Запрос<span class="r">.</span>УстановитьПараметр<span class="r">(</span><span class="black">"ВидНоменклатуры"</span><span class="r">, </span>Перечисления<span class="r">.</span>ВидыНоменклатуры<span class="r">.</span>Товар<span class="r">);
    </span>Запрос<span class="r">.</span>УстановитьПараметр<span class="r">(</span><span class="black">"МоментВремени"</span><span class="r">, </span>МоментВремени<span class="r">());
    </span>Запрос<span class="r">.</span>УстановитьПараметр<span class="r">(</span><span class="black">"Ссылка"</span><span class="r">, </span>Ссылка<span class="r">);
    </span>Запрос<span class="r">.</span>УстановитьПараметр<span class="r">(</span><span class="black">"Склад"</span><span class="r">, </span>Склад<span class="r">);

    <span class="g">// устанавливаем блокировки и стираем прежние движения,</span>
    </span>Блокировка<span class="r">.</span>Заблокировать<span class="r">();
    </span>Движения<span class="r">.</span>ОстаткиНоменклатуры<span class="r">.</span>Записать<span class="r">();

    <span class="g">// выполняем запрос и получаем результат.</span>
    </span>ВыборкаДетальныеЗаписи <span class="r">= </span>Запрос<span class="r">.</span>Выполнить<span class="r">().</span>Выбрать<span class="r">();

    <span class="g">// Для каждой записи,</span>
    Пока </span>ВыборкаДетальныеЗаписи<span class="r">.</span>Следующий<span class="r">() Цикл

        <span class="g">// если не товара на складе не хватает,</span>
        Если (</span>ВыборкаДетальныеЗаписи<span class="r">.</span>Количество <span class="r">&gt; </span>ВыборкаДетальныеЗаписи<span class="r">.</span>КоличествоОстаток<span class="r">) Тогда

            <span class="g">// то направляем сообщение пользователю,</span>
            </span>Сообщение <span class="r">= Новый </span>СообщениеПользователю<span class="r">;
            </span>Сообщение<span class="r">.</span>Текст <span class="r">= </span><span class="black">"На складе """ </span><span class="r">+ </span>Склад <span class="r">+ </span><span class="black">""" не хватает товара """ </span><span class="r">+ </span>ВыборкаДетальныеЗаписи<span class="r">.</span>Номенклатура
                <span class="r">+ </span><span class="black">"""! Требуется: " </span><span class="r">+ </span>ВыборкаДетальныеЗаписи<span class="r">.</span>Количество <span class="r">+ </span><span class="black">", остаток: " </span>
                <span class="r">+ </span>ВыборкаДетальныеЗаписи<span class="r">.</span>КоличествоОстаток <span class="r">+ </span><span class="black">"."</span><span class="r">;
            </span>Сообщение<span class="r">.</span>Сообщить<span class="r">();

            <span class="g">// и отказываемся проводить документ,</span>
            </span>Отказ <span class="r">= Истина;

        КонецЕсли;

        <span class="g">// если мы уже отказались проводить документ, то продолжаем искать недостачи, а движения больше не формируем</span>
        Если </span>Отказ <span class="r">Тогда

            Продолжить;

        КонецЕсли;

        </span><span class="g">// регистр ОстаткиНоменклатуры Расход
        </span>Движение <span class="r">= </span>Движения<span class="r">.</span>ОстаткиНоменклатуры<span class="r">.</span>Добавить<span class="r">();
        </span>Движение<span class="r">.</span>ВидДвижения <span class="r">= </span>ВидДвиженияНакопления<span class="r">.</span>Расход<span class="r">;
        </span>Движение<span class="r">.</span>Период <span class="r">= </span>Дата<span class="r">;
        </span>Движение<span class="r">.</span>Склад <span class="r">= </span>Склад<span class="r">;
        </span>Движение<span class="r">.</span>Номенклатура <span class="r">= </span>ВыборкаДетальныеЗаписи<span class="r">.</span>Номенклатура<span class="r">;
        </span>Движение<span class="r">.</span>Количество <span class="r">= </span>ВыборкаДетальныеЗаписи<span class="r">.</span>Количество<span class="r">;

    КонецЦикла;

КонецПроцедуры</span>
</span></pre>
        <p class="justify pad1">
            <img class="imgindent png" src="./решение 1.1_files/step.png" alt="Шаг № 11">
            Второй этап проведения - расчет себестоимости - выполняет процедура с привычным
            названием <span class="b">РассчитатьСебестоимость</span>.
        </p>
<pre class="pad1"><span class="b"><span class="g">// Даём ей параметр Отказ, чтобы она могла сообщить, если что-то пойдёт не так.</span>
<span class="r">Процедура </span>РассчитатьСебестоимость<span class="r">(</span>Отказ<span class="r">)

    <span class="g">// Прежде всего, выясняем какой у нас нынче метод списания себестоимости.</span>
    </span>Метод <span class="r">= </span>РегистрыСведений<span class="r">.</span>МетодСписанияСебестоимости<span class="r">.</span>ПолучитьПоследнее<span class="r">(</span>Дата<span class="r">).</span>Метод<span class="r">;

    <span class="g">// Если ещё никакой,</span>
    Если </span>Метод <span class="r">= </span>Перечисления<span class="r">.</span>УчетнаяПолитика<span class="r">.</span>ПустаяСсылка<span class="r">() Тогда

        <span class="g">// то сразу заявляем пользователю, дескать, так дело не пойдёт - Вы уж определитесь сначала,</span>
        </span>Сообщение <span class="r">= Новый </span>СообщениеПользователю<span class="r">;
        </span>Сообщение<span class="r">.</span>Текст <span class="r">= </span><span class="black">"Себестоимостьне может быть рассчитана так как не определён Метод списания себестоимости!"</span><span class="r">;
        </span>Сообщение<span class="r">.</span>Сообщить<span class="r">();

        <span class="g">// а до тех пор мы никаких движений делать не будем.</span>
        </span>Отказ <span class="r">= Истина;

        Возврат;

    КонецЕсли;

    <span class="g">// Ну, а если пользователь уже и определился, то будем писать в оставшиеся регистры.</span>
    </span>Движения<span class="r">.</span>СтоимостьНоменклатуры<span class="r">.</span>Записывать <span class="r">= Истина;
    </span>Движения<span class="r">.</span>Продажи<span class="r">.</span>Записывать <span class="r">= Истина;

    <span class="g">// Читать будем только СтоимостьНоменклатуры, и только в нём будем блокировать прежние движения,</span>
    </span>Движения<span class="r">.</span>СтоимостьНоменклатуры<span class="r">.</span>БлокироватьДляИзменения <span class="r">= Истина;

    <span class="g">// и номенклатуру, упомянутую в табличной части.</span>
    </span>Блокировка <span class="r">= Новый </span>БлокировкаДанных<span class="r">;
    </span>ЭлементБлокировки <span class="r">= </span>Блокировка<span class="r">.</span>Добавить<span class="r">(</span><span class="black">"РегистрНакопления.СтоимостьНоменклатуры"</span><span class="r">);
    </span>ЭлементБлокировки<span class="r">.</span>Режим <span class="r">= </span>РежимБлокировкиДанных<span class="r">.</span>Исключительный<span class="r">;
    </span>ЭлементБлокировки<span class="r">.</span>ИсточникДанных <span class="r">= </span>СписокНоменклатуры<span class="r">;
    </span>ЭлементБлокировки<span class="r">.</span>ИспользоватьИзИсточникаДанных<span class="r">(</span><span class="black">"Номенклатура"</span><span class="r">, </span><span class="black">"Номенклатура"</span><span class="r">);</span>

    <span class="g">// Подготавливаем запрос:
    //   1) Поскольку в регистр продажи нужно писать и услуги и выручку, берём из табличной части всю номенклатуру,
    //      с указанием вида номенклатуры, и сумму, и количество, сворачиваем "дубли строк" и кладём во временную
    //      таблицу
    //   2) присоединяем остатки по партиям, на указанный момент времени, готовим итоги по номенклатуре, позволяющие
    //      суммарные остатки по всем партиям. Сортируем по моменту времени поступления партии, пока что поубыванию,
    //      что соответствует методу ЛИФО.</span>
    Запрос <span class="r">= Новый </span>Запрос<span class="r">;</span>
    Запрос<span class="r">.</span>Текст <span class="r">=</span>
        <span class="black">"ВЫБРАТЬ
        |   РасходнаяНакладнаяСписокНоменклатуры.Номенклатура,
        |   РасходнаяНакладнаяСписокНоменклатуры.Номенклатура.ВидНоменклатуры КАК ВидНоменклатуры,
        |   СУММА(РасходнаяНакладнаяСписокНоменклатуры.Количество) КАК Количество,
        |   СУММА(РасходнаяНакладнаяСписокНоменклатуры.Сумма) КАК Сумма
        |ПОМЕСТИТЬ РасходнаяНакладная
        |ИЗ
        |   Документ.РасходнаяНакладная.СписокНоменклатуры КАК РасходнаяНакладнаяСписокНоменклатуры
        |ГДЕ
        |   РасходнаяНакладнаяСписокНоменклатуры.Ссылка = &amp;Ссылка
        |
        |СГРУППИРОВАТЬ ПО
        |   РасходнаяНакладнаяСписокНоменклатуры.Номенклатура,
        |   РасходнаяНакладнаяСписокНоменклатуры.Номенклатура.ВидНоменклатуры
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ
        |   РасходнаяНакладная.Номенклатура КАК Номенклатура,
        |   РасходнаяНакладная.ВидНоменклатуры КАК ВидНоменклатуры,
        |   РасходнаяНакладная.Количество КАК Количество,
        |   РасходнаяНакладная.Сумма КАК Сумма,
        |   СтоимостьНоменклатурыОстатки.Партия КАК Партия,
        |   ЕСТЬNULL(СтоимостьНоменклатурыОстатки.КоличествоОстаток, 0) КАК КоличествоОстаток,
        |   ЕСТЬNULL(СтоимостьНоменклатурыОстатки.СтоимостьОстаток, 0) КАК СтоимостьОстаток
        |ИЗ
        |   РасходнаяНакладная КАК РасходнаяНакладная
        |       ЛЕВОЕ СОЕДИНЕНИЕ РегистрНакопления.СтоимостьНоменклатуры.Остатки(
        |               &amp;МоментВремени,
        |               Номенклатура В
        |                   (ВЫБРАТЬ
        |                       РасходнаяНакладная.Номенклатура
        |                   ИЗ
        |                       РасходнаяНакладная)) КАК СтоимостьНоменклатурыОстатки
        |       ПО РасходнаяНакладная.Номенклатура = СтоимостьНоменклатурыОстатки.Номенклатура
        |
        |УПОРЯДОЧИТЬ ПО
        |   СтоимостьНоменклатурыОстатки.Партия.МоментВремени УБЫВ
        |ИТОГИ
        |   МАКСИМУМ(ВидНоменклатуры),
        |   МАКСИМУМ(Количество),
        |   МАКСИМУМ(Сумма),
        |   СУММА(КоличествоОстаток)
        |ПО
        |   Номенклатура"</span><span class="r">;

    <span class="g">// Если же текущий метод списания себестоимости ФИФО, которому соответствует сортировка повозрастанию</span>
    Если </span>Метод <span class="r">= </span>Перечисления<span class="r">.</span>УчетнаяПолитика<span class="r">.</span>ФИФО <span class="r">Тогда

        <span class="g">// тогда указание сортировать поубыванию стираем.</span>
        </span>Запрос<span class="r">.</span>Текст <span class="r">= </span>СтрЗаменить<span class="r">(</span>Запрос<span class="r">.</span>Текст<span class="r">, </span><span class="black">" УБЫВ"</span><span class="r">, </span><span class="black">""</span><span class="r">);

    КонецЕсли;

    <span class="g">// Задаём параметры запроса,</span>
    </span>Запрос<span class="r">.</span>УстановитьПараметр<span class="r">(</span><span class="black">"МоментВремени"</span><span class="r">, </span>МоментВремени<span class="r">());
    </span>Запрос<span class="r">.</span>УстановитьПараметр<span class="r">(</span><span class="black">"Ссылка"</span><span class="r">, </span>Ссылка<span class="r">);
    </span>Запрос<span class="r">.</span>УстановитьПараметр<span class="r">(</span><span class="black">"Склад"</span><span class="r">, </span>Склад<span class="r">);

    <span class="g">// устанавливаем блокировки и стираем прежние движения в регистре, из которого собираемся читать,</span>
    </span>Блокировка<span class="r">.</span>Заблокировать<span class="r">();
    </span>Движения<span class="r">.</span>СтоимостьНоменклатуры<span class="r">.</span>Записать<span class="r">();

    <span class="g">// выполняем запрос и получаем итоги по номенклатуре.</span>
    </span>ВыборкаНоменклатура <span class="r">= </span>Запрос<span class="r">.</span>Выполнить<span class="r">().</span>Выбрать<span class="r">(</span>ОбходРезультатаЗапроса<span class="r">.</span>ПоГруппировкам<span class="r">);

    <span class="g">// По каждой номенклатуре,</span>
    Пока </span>ВыборкаНоменклатура<span class="r">.</span>Следующий<span class="r">() Цикл

        <span class="g">// если это товар,</span>
        Если (</span>ВыборкаНоменклатура<span class="r">.</span>ВидНоменклатуры <span class="r">= </span>Перечисления<span class="r">.</span>ВидыНоменклатуры<span class="r">.</span>Товар<span class="r">)
            <span class="g">// проверяем, хватает ли его в остатках.</span>
            И (</span>ВыборкаНоменклатура<span class="r">.</span>Количество <span class="r">&gt; </span>ВыборкаНоменклатура<span class="r">.</span>КоличествоОстаток<span class="r">) Тогда

            <span class="g">// Если не хватает, предупреждаем об этом пользователя,</span>
            </span>Сообщение <span class="r">= Новый </span>СообщениеПользователю<span class="r">;
            </span>Сообщение<span class="r">.</span>Текст <span class="r">= </span><span class="black">"Не хватает товара """ </span><span class="r">+ </span>ВыборкаНоменклатура<span class="r">.</span>Номенклатура <span class="r">+ </span><span class="black">"""! Требуется: " </span>
                <span class="r">+ </span>ВыборкаНоменклатура<span class="r">.</span>Количество <span class="r">+ </span><span class="black">", остаток: " </span><span class="r">+ </span>ВыборкаНоменклатура<span class="r">.</span>КоличествоОстаток <span class="r">+ </span><span class="black">"."</span><span class="r">;
            </span>Сообщение<span class="r">.</span>Сообщить<span class="r">();

            <span class="g">// и отказываемся проводить документ.</span>
            </span>Отказ <span class="r">= Истина;

        КонецЕсли;

        <span class="g">// Если мы уже отказались проводить документ, то продолжаем искать недостачи, а движения больше не формируем</span>
        Если </span>Отказ <span class="r">Тогда

            Продолжить;

        КонецЕсли;

        <span class="g">// Пфу-ф-ф, а чего это я?! Вы ж всё это уже раз шесть делали.</span>
        <span class="g">// Ну, в общем, там дальше проводки и всё такое - не мне вас учить ;)</span>

        </span>СтоимостьВСЕГО <span class="r">= </span><span class="black">0</span><span class="r">;

        Если </span>ВыборкаНоменклатура<span class="r">.</span>ВидНоменклатуры <span class="r">= </span>Перечисления<span class="r">.</span>ВидыНоменклатуры<span class="r">.</span>Товар <span class="r">Тогда

            </span>ОсталосьСписать <span class="r">= </span>ВыборкаНоменклатура<span class="r">.</span>Количество<span class="r">;

            </span>ВыборкаДетальныеЗаписи <span class="r">= </span>ВыборкаНоменклатура<span class="r">.</span>Выбрать<span class="r">();

            Пока (</span>ОсталосьСписать <span class="r">&gt; </span><span class="black">0</span><span class="r">) И </span>ВыборкаДетальныеЗаписи<span class="r">.</span>Следующий<span class="r">() Цикл

                </span><span class="g">// регистр СтоимостьНоменклатуры Расход
                </span>Движение <span class="r">= </span>Движения<span class="r">.</span>СтоимостьНоменклатуры<span class="r">.</span>Добавить<span class="r">();
                </span>Движение<span class="r">.</span>ВидДвижения <span class="r">= </span>ВидДвиженияНакопления<span class="r">.</span>Расход<span class="r">;
                </span>Движение<span class="r">.</span>Период <span class="r">= </span>Дата<span class="r">;
                </span>Движение<span class="r">.</span>Номенклатура <span class="r">= </span>ВыборкаДетальныеЗаписи<span class="r">.</span>Номенклатура<span class="r">;
                </span>Движение<span class="r">.</span>Партия <span class="r">= </span>ВыборкаДетальныеЗаписи<span class="r">.</span>Партия<span class="r">;
                </span>Движение<span class="r">.</span>Количество <span class="r">= </span>Мин<span class="r">(</span>ОсталосьСписать<span class="r">, </span>ВыборкаДетальныеЗаписи<span class="r">.</span>КоличествоОстаток<span class="r">);
                </span>Движение<span class="r">.</span>Стоимость <span class="r">= (</span>Движение<span class="r">.</span>Количество <span class="r">* </span>ВыборкаДетальныеЗаписи<span class="r">.</span>СтоимостьОстаток<span class="r">)
                                     / </span>ВыборкаДетальныеЗаписи<span class="r">.</span>КоличествоОстаток<span class="r">;

                </span>СтоимостьВСЕГО <span class="r">= </span>СтоимостьВСЕГО <span class="r">+ </span>Движение<span class="r">.</span>Стоимость<span class="r">;
                </span>ОсталосьСписать <span class="r">= </span>ОсталосьСписать <span class="r">- </span>Движение<span class="r">.</span>Количество<span class="r">;

            КонецЦикла;

        КонецЕсли;

        </span><span class="g">// регистр Продажи
        </span>Движение <span class="r">= </span>Движения<span class="r">.</span>Продажи<span class="r">.</span>Добавить<span class="r">();
        </span>Движение<span class="r">.</span>Период <span class="r">= </span>Дата<span class="r">;
        </span>Движение<span class="r">.</span>Номенклатура <span class="r">= </span>ВыборкаНоменклатура<span class="r">.</span>Номенклатура<span class="r">;
        </span>Движение<span class="r">.</span>Количество <span class="r">= </span>ВыборкаНоменклатура<span class="r">.</span>Количество<span class="r">;
        </span>Движение<span class="r">.</span>Стоимость <span class="r">= </span>СтоимостьВСЕГО<span class="r">;
        </span>Движение<span class="r">.</span>Выручка <span class="r">= </span>ВыборкаНоменклатура<span class="r">.</span>Сумма<span class="r">;

    КонецЦикла;

КонецПроцедуры</span>
</span></pre>
        <p class="justify pad1">
            Ну вот, кажись, управились и с этим. Ладно, пока - встретимся в следующих задачах. Успехов!
        </p>
    </div>


                </div>
            </div>
        </div>
    </div>
    

        	            </form>
		            </div>
	            </div>
	            <div id="footer">
		            <div>Версия сайта № 1.7.5936.18863</div>© 2005—2020 Архитектура Х
	            </div>
                
                <div id="counters">
                    <img src="./решение 1.1_files/cnt.aspx" border="0" width="88" height="31" alt="1Gb.ru counter">
                    <!--Openstat-->
                    <span id="openstat2108175"><a target="_blank" href="http://rating.openstat.ru/?cid=2108175"><img alt="Openstat" border="0" src="http://openstat.net/digits?cid=2108175&amp;ls=0&amp;ln=5043"></a></span>
                    <script type="text/javascript">
                        var openstat = { counter: 2108175, image: 5043, next: openstat, track_links: 'ext' }; document.write(unescape('%3Cscript%20src=%22http' + (('https:' == document.location.protocol) ? 's' : '') + '://openstat.net/cnt.js%22%20defer=%22defer%22%3E%3C/script%3E'));
                    </script><script src="http://openstat.net/cnt.js" defer="defer"></script>
                    <!--/Openstat-->
                    <a href="http://biysk24.ru/top/?do=v&amp;i=208" target="_blank">
                        <img src="http://biysk24.ru/top/?do=in&amp;id=208" border="0" alt="Рейтинг сайтов Бийска">
                    </a>
                </div>
                
            </div>
		</div>
	</div>

	<script type="text/javascript" src="./решение 1.1_files/Ax.js.Без названия"></script>		
    
    <!--[if lt IE 7]>
        <script type="text/javascript" src='/js/ie_png.js'></script>
        <script type="text/javascript">
        ie_png.fix('.png');
        </script>
    <![endif]-->
    <script type="text/javascript" src="./решение 1.1_files/highslide.packed.js.Без названия"></script>
    <script type="text/javascript">
        hs.graphicsDir = '/highslide/graphics/';
        hs.wrapperClassName = 'wide-border';
    </script>
    

 

<div class="highslide-container" style="padding: 0px; border: none; margin: 0px; position: absolute; left: 0px; top: 0px; width: 100%; z-index: 1001; direction: ltr;"><a class="highslide-loading" title="Click to cancel" href="javascript:;" style="position: absolute; top: -9999px; opacity: 0.75; z-index: 1;">Loading...</a><div style="display: none;"></div><table cellspacing="0" style="padding: 0px; border: none; margin: 0px; visibility: hidden; position: absolute; border-collapse: collapse; width: 0px;"><tbody style="padding: 0px; border: none; margin: 0px;"><tr style="padding: 0px; border: none; margin: 0px; height: auto;"><td style="padding: 0px; border: none; margin: 0px; line-height: 0; font-size: 0px; background: url(&quot;http://v2.ax-online.ru/highslide/graphics/outlines/drop-shadow.png&quot;) 0px 0px; height: 20px; width: 20px;"></td><td style="padding: 0px; border: none; margin: 0px; line-height: 0; font-size: 0px; background: url(&quot;http://v2.ax-online.ru/highslide/graphics/outlines/drop-shadow.png&quot;) 0px -40px; height: 20px; width: 20px;"></td><td style="padding: 0px; border: none; margin: 0px; line-height: 0; font-size: 0px; background: url(&quot;http://v2.ax-online.ru/highslide/graphics/outlines/drop-shadow.png&quot;) -20px 0px; height: 20px; width: 20px;"></td></tr><tr style="padding: 0px; border: none; margin: 0px; height: auto;"><td style="padding: 0px; border: none; margin: 0px; line-height: 0; font-size: 0px; background: url(&quot;http://v2.ax-online.ru/highslide/graphics/outlines/drop-shadow.png&quot;) 0px -80px; height: 20px; width: 20px;"></td><td class="drop-shadow highslide-outline" style="padding: 0px; border: none; margin: 0px; position: relative;"></td><td style="padding: 0px; border: none; margin: 0px; line-height: 0; font-size: 0px; background: url(&quot;http://v2.ax-online.ru/highslide/graphics/outlines/drop-shadow.png&quot;) -20px -80px; height: 20px; width: 20px;"></td></tr><tr style="padding: 0px; border: none; margin: 0px; height: auto;"><td style="padding: 0px; border: none; margin: 0px; line-height: 0; font-size: 0px; background: url(&quot;http://v2.ax-online.ru/highslide/graphics/outlines/drop-shadow.png&quot;) 0px -20px; height: 20px; width: 20px;"></td><td style="padding: 0px; border: none; margin: 0px; line-height: 0; font-size: 0px; background: url(&quot;http://v2.ax-online.ru/highslide/graphics/outlines/drop-shadow.png&quot;) 0px -60px; height: 20px; width: 20px;"></td><td style="padding: 0px; border: none; margin: 0px; line-height: 0; font-size: 0px; background: url(&quot;http://v2.ax-online.ru/highslide/graphics/outlines/drop-shadow.png&quot;) -20px -20px; height: 20px; width: 20px;"></td></tr></tbody></table></div></body></html>